## Windows内核安全与驱动开发 ##
**谭文，陈铭霖著**
# 基础篇 #
1. 内核上机指导
	
	**下载和使用WDK**
	
		WDK7.0下载地址：		

		https://www.microsoft.com/en-us/download/details.aspx?id=11800
	
	     尽量安装到比较简单的路径，一定不能带中文，否则有可能会出问题
	



-  **编写第一个C文件**
		
		在wdk安装之后，点击 开始-> 菜单-> 所有程序会发现增加了“Windows Driver Kits”和”Windows Driver Kits Documentation“，

		我们可以打开Windows Driver Kits Documentation来查看帮助文档，就如同查看MSDN一样。

		我们可以用记事本编写我们的第一个驱动文件，下面给出一个示例：

			//@file first.c

			//@author crazy_chu

			//@data2008-11-1
		
			#include<ntddk.h>

			//提供一个unload函数只是为了让程序能动态卸载，方便调试
			void DriverUnload(PDRIVER_OBJECT driver)

		    {	
				//只是打印一句话
    			DbgPrint("first: our driver is unloading...\r\n");

		    }
			//DriverEntry,入口函数，相当与main
			NTSTATUS DriverEntry(PDRIVER_OBJECT driver，PUNICODE_STRING reg_path)

			{
				//这里就相当于main函数
				//这个是指定卸载回调函数
				driver->DriverUnload = DriverUnload;
				return STATUS_SUCCESS;
			}

		把上面代码保存成first.c，然后新建个目录，把这个文件保存进去


	
- **编译一个工程**
 	
		新建一个文件名字叫 makefile,注意：这个名字是固定的不能更改，内容如下：
   
			`!IF 0`

			Copyright (C) Microsoft Corporation, 1997 - 1998

			Module Name:

			makefile.

			!ENDIF

			#
			# DO NOT EDIT THIS FILE!!!  Edit .\sources. if you want to add a new source
			# file to this component.  This file merely indirects to the real make file
			# that is shared by all the components of Windows NT
			#
			!INCLUDE $(NTMAKEENV)\makefile.def


		还需要新建一个SOURCES的文件，内容关系到编译出来的sys的名字，编译那些文件等等，内容如下：

		TARGETNAME=first   //表示编译出来的名字
		
		TARGETTYPE=DRIVER//类型为驱动

		SOURCES=first.c		//表示要编译的是哪个文件，如果有多个文件用逗号隔开


		把SOURCES，makefile，first.c，放到同一个目录中，准备编译。

		下面开始编译，先打开 开始 菜单，选择 所有程序 ，然后选择 Windows Driver Kits
		-->WDK版本，(比如是WinDDK7600.16385.1)，-->Build Enviroments-->Windows XP-->Launch Windows XP
	 	x86 Checked Build Enviroments.会出现一个控制台，先用”CD“命令进入刚才存放三个文件的目录中，
		然后输入”build‘，编译好后sys文件就会存放在\first\objchk_wxp_x86\i386下，这个文件不能像EXE双击就可以运行，它需要一个安装工具进行安装


    

- **安装和运行**

	运行工具不多做解释，也不推荐，因为病毒太多，本书使用的是srvinstw.exe，需要的小伙伴可自行下载

	
- **运行与查看输出信息**

	我们可以直接去微软官网下载DebugView，`https://answers.microsoft.com/en-us/windows/forum/windows_10-windows_install/debugview/46e74e09-5de1-428d-95a7-8af99b32868a`

	安装好之后打开上方菜单栏，Capture 把Capture Kernel勾上，然后用前面的驱动加载工具，运行驱动，便可以在DebugView中看到输出结果

- **在虚拟机中运行**
	
	因为驱动是运行在零环的，所以一旦代码出错，不会像三环应用程序那样直接报错，而是会直接蓝屏，为了避免调试驱动时太过于麻烦，所以
	我们最好时把编译好的驱动放到虚拟机中运行，这里推荐虚拟机Vmware ，虚拟机系统推荐安装windows xp，安装教程可自行百度

- **双机调试设置**

	我们安装WDK时自带了一个工具Windbg，这个工具非常强大，可以帮助我们调试驱动程序
	
	`https://blog.csdn.net/yangdazhi/article/details/14044985`

	可以参考这个教程配置。编辑的时候不能放图片，所以就只能麻烦一点了。



# 总结 #

	这章是基础，懂的大佬可直接跳过，2020/3/28 就我这个时间段有个问题，windbg符号表不提供XP的离线下载了，目前我也没想到什么好办法，可能我比较菜的原因吧。
